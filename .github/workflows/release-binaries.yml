name: Build and Upload Standalone Binaries

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-all-platforms:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            cli_name: mgzon-linux
            gui_ext: AppImage
            
          - os: macos-latest
            platform: macos
            cli_name: mgzon-macos
            gui_ext: dmg
            
          - os: windows-latest
            platform: windows
            cli_name: mgzon-win.exe
            gui_ext: exe

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CLI
        run: |
          npm run build
          npm run package
          
          echo "=== Built CLI binaries ==="
          ls -la bin/

      - name: Rename CLI binary for current platform
        shell: bash
        run: |
          mkdir -p bin
          echo "Looking for CLI binary..."
          
          # Find and rename based on platform
          case "${{ matrix.platform }}" in
            linux)
              if [ -f "bin/mgzon" ]; then
                mv bin/mgzon "bin/${{ matrix.cli_name }}"
                echo "Renamed mgzon to ${{ matrix.cli_name }}"
              fi
              ;;
            macos)
              if [ -f "bin/mgzon" ]; then
                mv bin/mgzon "bin/${{ matrix.cli_name }}"
                echo "Renamed mgzon to ${{ matrix.cli_name }}"
              fi
              ;;
            windows)
              if [ -f "bin/mgzon.exe" ]; then
                mv bin/mgzon.exe "bin/${{ matrix.cli_name }}"
                echo "Renamed mgzon.exe to ${{ matrix.cli_name }}"
              fi
              ;;
          esac
          
          echo "=== Final CLI binaries ==="
          ls -la bin/

      - name: Build GUI
        if: matrix.platform != 'windows' || matrix.os != 'windows-latest'  # Skip GUI on Windows for now
        run: |
          cd gui
          npm ci
          
          # Build GUI for current platform
          case "${{ matrix.platform }}" in
            linux)
              npm run package:linux
              ;;
            macos)
              npm run package:mac
              ;;
            windows)
              npm run package:win
              ;;
          esac
          cd ..

      - name: Prepare assets for upload
        shell: bash
        run: |
          mkdir -p upload-assets
          
          # Copy CLI binary
          if [ -f "bin/${{ matrix.cli_name }}" ]; then
            cp "bin/${{ matrix.cli_name }}" "upload-assets/"
            echo "Copied CLI: ${{ matrix.cli_name }}"
          fi
          
          # Copy GUI if exists
          if [ -d "bin/gui" ]; then
            # Find GUI file
            GUI_FILE=$(find bin/gui -name "*.${{ matrix.gui_ext }}" -o -name "MGZON GUI*.${{ matrix.gui_ext }}" | head -1)
            if [ -n "$GUI_FILE" ] && [ -f "$GUI_FILE" ]; then
              cp "$GUI_FILE" "upload-assets/"
              echo "Copied GUI: $(basename "$GUI_FILE")"
            fi
          fi
          
          # Create checksums
          cd upload-assets
          for file in *; do
            if [ -f "$file" ]; then
              case "${{ matrix.os }}" in
                ubuntu-latest|macos-latest)
                  shasum -a 256 "$file" > "$file.sha256"
                  ;;
                windows-latest)
                  # PowerShell on Windows
                  powershell -Command "Get-FileHash '$file' -Algorithm SHA256 | ForEach-Object { '{0}  {1}' -f \$_.Hash.ToLower(), '$file' } | Out-File -Encoding ascii '$file.sha256'"
                  ;;
              esac
              echo "Created checksum for $file"
            fi
          done
          cd ..
          
          echo "=== Upload assets ==="
          ls -la upload-assets/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: upload-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}