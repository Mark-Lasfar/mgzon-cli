name: Build and Upload Standalone Binaries

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            gui_cmd: linux
            cli_name: mgzon-linux
            gui_ext: AppImage

          - os: macos-latest
            gui_cmd: mac
            cli_name: mgzon-macos
            gui_ext: dmg

          - os: windows-latest
            gui_cmd: win
            cli_name: mgzon-win.exe
            gui_ext: exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root dependencies
        run: npm ci

      # ---------------- CLI ----------------
      - name: Build CLI
        run: npm run build

      - name: Package CLI (pkg)
        run: npm run package

      # ---------------- GUI ----------------
      - name: Install GUI dependencies
        run: cd gui && npm ci

      - name: Package GUI
        run: cd gui && npm run package:gui:${{ matrix.gui_cmd }}

      # ---------------- Organize files ----------------
      - name: Organize binaries
        shell: bash
        run: |
          echo "Runner OS: $RUNNER_OS"
          # CLI
          if [ "${{ runner.os }}" = "Linux" ]; then
            mv -f bin/mgzon "${{ matrix.cli_name }}" || true
          elif [ "${{ runner.os }}" = "macOS" ]; then
            mv -f bin/mgzon "${{ matrix.cli_name }}" || true
          else
            # Windows
            mv -f "bin/mgzon.exe" "${{ matrix.cli_name }}" || true
          fi

          # GUI - move first matching file (if present)
          if [ -d bin/gui ]; then
            for f in bin/gui/*."${{ matrix.gui_ext }}"; do
              if [ -e "$f" ]; then
                echo "Found GUI file: $f"
                mv -f "$f" "MGZON-GUI-${{ matrix.os }}.${{ matrix.gui_ext }}" || true
                break
              fi
            done
          fi

      - name: List generated files
        run: ls -la || true

      # ---------------- Checksums ----------------
      - name: Generate checksum (Linux / macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -f "${{ matrix.cli_name }}" ]; then
            shasum -a 256 "${{ matrix.cli_name }}" > "${{ matrix.cli_name }}.sha256"
          else
            echo "CLI binary not found: ${{ matrix.cli_name }}"
            exit 1
          fi

      - name: Generate checksum (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path "${{ matrix.cli_name }}") {
            $hash = Get-FileHash -Path "${{ matrix.cli_name }}" -Algorithm SHA256
            ("{0}  {1}" -f $hash.Hash.ToLower(), "${{ matrix.cli_name }}") | Out-File -Encoding ascii "${{ matrix.cli_name }}.sha256"
          } else {
            Write-Error "CLI binary not found: ${{ matrix.cli_name }}"
            exit 1
          }

      - name: List files before upload
        run: ls -la || true

      # ---------------- Upload ----------------
      - name: Upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.cli_name }}
            ${{ matrix.cli_name }}.sha256
            MGZON-GUI-${{ matrix.os }}.${{ matrix.gui_ext }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}