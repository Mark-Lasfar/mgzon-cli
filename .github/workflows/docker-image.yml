name: Build and Test Docker Image

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Ù…ÙÙŠØ¯ Ù„Ùˆ Ù‡ØªØ¹Ù…Ù„ tags Ø£Ùˆ provenance ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3   # v3 Ù…Ø³ØªÙ‚Ø± Ø¬Ø¯Ù‹Ø§ØŒ v4 Ù„Ø³Ù‡ Ø¬Ø¯ÙŠØ¯ Ø´ÙˆÙŠØ©ØŒ Ø®Ù„ÙŠÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø±

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          load: true                  # <--- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¯Ù‡ Ø¨Ø³
          tags: mgzon-cli:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64 # Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø¨Ø³ ÙƒÙˆÙŠØ³

      - name: Test CLI in container
        run: |
          echo "ğŸ§ª Testing mgzon-cli Docker image..."
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù€ banner ÙˆØ§Ù„Ù€ help
          docker run --rm mgzon-cli:latest --help | grep "MGZON CLI" || exit 1

          # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù€ version (Ø¯Ù„ÙˆÙ‚ØªÙŠ 2.0.2)
          docker run --rm mgzon-cli:latest --version | grep "2.0.2" || exit 1
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø£Ù…Ø± Ø¨Ø³ÙŠØ· Ø²ÙŠ whoami (Ù…Ø´ Ù‡ÙŠØ­ØªØ§Ø¬ auth)
          docker run --rm mgzon-cli:latest whoami
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø£Ù…Ø± support
          docker run --rm mgzon-cli:latest support | grep "MGZON Support"
          
          echo "âœ… Docker image built and CLI tests passed successfully!"