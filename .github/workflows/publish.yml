name: Build & Publish Package

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '**.png'
      - '**.svg'
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Fix pkg configuration
        run: node fix-pkg.js

      - name: Update version automatically
        id: version
        run: |
          # Get current version and increment patch
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Extract major.minor.patch
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "New version: $NEW_VERSION"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Update root package.json
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          
          # Update GUI package.json
          cd gui
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          cd ..

      - name: Build CLI
        run: |
          # Build and package CLI
          npm run build
          npm run package:fix
          
          # Verify CLI binaries
          echo "=== CLI Binaries ==="
          ls -la bin/
          echo "=== Binary Info ==="
          ./bin/mgzon-linux --version || echo "Testing binary..."

      - name: Build GUI (Linux only in CI)
        run: |
          cd gui
          npm ci
          npm run package:linux
          cd ..
          
          echo "=== GUI Build ==="
          ls -la gui/build/linux-unpacked/ || echo "No linux-unpacked directory"
          find gui/build -name "*.AppImage" -o -name "MGZON GUI*" | xargs ls -la 2>/dev/null || true

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Copy CLI binaries
          cp bin/mgzon-linux release-assets/ 2>/dev/null || true
          cp bin/mgzon-macos release-assets/ 2>/dev/null || true
          cp bin/mgzon-win.exe release-assets/ 2>/dev/null || true
          
          # Copy GUI from correct location
          if [ -d "gui/build" ]; then
            find gui/build -maxdepth 1 -type f \( -name "*.AppImage" -o -name "*.dmg" -o -name "*.exe" \) -exec cp {} release-assets/ \;
          fi
          
          # Also check bin/gui
          if [ -d "bin/gui" ]; then
            cp bin/gui/* release-assets/ 2>/dev/null || true
          fi
          
          # Create checksums
          cd release-assets
          for file in *; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
              echo "Created checksum for $file"
            fi
          done
          cd ..
          
          echo "=== Release Assets ==="
          ls -la release-assets/

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: MGZON CLI v${{ env.NEW_VERSION }}
          body: |
            ## MGZON CLI v${{ env.NEW_VERSION }}
            
            ### ðŸš€ New Features
            - Automated CI/CD pipeline
            - Cross-platform binaries
            - Integrated GUI application
            
            ### ðŸ“¦ Binaries Included
            #### CLI (Command Line Interface)
            - `mgzon-linux` - Linux x64 binary
            - `mgzon-macos` - macOS x64 binary  
            - `mgzon-win.exe` - Windows x64 binary
            
            #### GUI (Graphical User Interface) - Linux Only in CI
            - `MGZON GUI-*.AppImage` - Linux GUI application
            
            ### ðŸ”§ Installation Options
            
            #### Option 1: Install via npm (Recommended)
            ```bash
            # Install globally
            npm install -g @mg-cli/cli
            
            # Verify installation
            mgzon --version
            mz --version
            ```
            
            #### Option 2: Use Direct Binary Downloads
            ```bash
            # Linux
            chmod +x mgzon-linux
            ./mgzon-linux --help
            
            # macOS
            chmod +x mgzon-macos
            ./mgzon-macos --help
            
            # Windows
            # Run mgzon-win.exe directly
            ```
            
            #### Option 3: Docker
            ```bash
            docker run --rm ghcr.io/${{ github.repository }}:latest --version
            ```
            
            ### ðŸ” Security & Verification
            All files include SHA256 checksums for verification. Always verify checksums before execution.
            
            ### ðŸ“ Documentation
            See [README.md](https://github.com/Mark-Lasfar/mgzon-cli#readme) for full documentation.
            
            ### ðŸ› Issues & Support
            Report issues at: https://github.com/Mark-Lasfar/mgzon-cli/issues
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup npm for publishing (npmjs.org)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Verify npm authentication (npmjs.org)
        run: |
          npm whoami --registry=https://registry.npmjs.org/ || echo "Will use NPM_TOKEN for authentication"

      - name: Check if version exists on npmjs.org
        id: check_npm
        run: |
          if npm view @mg-cli/cli@${{ env.NEW_VERSION }} --registry=https://registry.npmjs.org/ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ env.NEW_VERSION }} already exists on npmjs.org"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ env.NEW_VERSION }} not found on npmjs.org"
          fi

      - name: Publish to npmjs.org
        if: steps.check_npm.outputs.exists == 'false'
        run: |
          npm publish --access public --registry https://registry.npmjs.org/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup npm for GitHub Packages (Optional)
        if: ${{ secrets.MGZON_PKG_TOKEN != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'
          cache: 'npm'

      - name: Configure GitHub Packages registry
        if: ${{ secrets.MGZON_PKG_TOKEN != '' }}
        run: |
          echo "@mg-cli:registry=https://npm.pkg.github.com/" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.MGZON_PKG_TOKEN }}" >> ~/.npmrc

      - name: Check if version exists on GitHub Packages
        if: ${{ secrets.MGZON_PKG_TOKEN != '' }}
        id: check_github_pkg
        run: |
          if npm view @mg-cli/cli@${{ env.NEW_VERSION }} --registry=https://npm.pkg.github.com/ >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ env.NEW_VERSION }} already exists on GitHub Packages"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ env.NEW_VERSION }} not found on GitHub Packages"
          fi

      - name: Publish to GitHub Packages
        if: ${{ secrets.MGZON_PKG_TOKEN != '' && steps.check_github_pkg.outputs.exists == 'false' }}
        run: |
          npm publish --access public --registry https://npm.pkg.github.com/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.MGZON_PKG_TOKEN }}

      - name: Skip GitHub Packages publish (no token or exists)
        if: ${{ secrets.MGZON_PKG_TOKEN == '' || (secrets.MGZON_PKG_TOKEN != '' && steps.check_github_pkg.outputs.exists == 'true') }}
        run: |
          if [ -z "${{ secrets.MGZON_PKG_TOKEN }}" ]; then
            echo "MGZON_PKG_TOKEN not set, skipping GitHub Packages publish"
          else
            echo "Version already exists on GitHub Packages, skipping publish"
          fi

      - name: Commit version updates
        if: success()
        run: |
          git add package.json gui/package.json fix-pkg.js
          git commit -m "chore: release v${{ env.NEW_VERSION }} [skip ci]"
          git push origin HEAD:master